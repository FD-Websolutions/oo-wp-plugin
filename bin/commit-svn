#!/bin/sh

# Deploys a tag of the plugin into the WP SVN.

TAG_PATH=tags
TRUNK_PATH=trunk
PREFIX=/tmp
PPWDt=`pwd`
TAG_PREFIX="v"
NEW_TAG=${1#"$TAG_PREFIX"}

if [ -z $SVNURL ]; then
	>&2 echo "Env variable SVNURL is missing"
	exit 1
fi

if [ -z $NEW_TAG ]; then
	>&2 echo "Tag argument is missing"
	exit 2
fi

grep "= $NEW_TAG =" readme.txt > /dev/null

if [ $? -ne 0 ]; then
	>&2 echo "Missing changelog entry for tag $NEW_TAG"
	exit 3
fi

RELEASE_DIR=`mktemp -d`
>&2 echo "RELEASE_DIR is $RELEASE_DIR"

PREFIX=$RELEASE_DIR make release
cd "$RELEASE_DIR/onoffice"

if [ "$2" = "--stable" ]; then
	ed readme.txt <<EDSCRIPT
7
i
Stable tag: $NEW_TAG
.
w
q
EDSCRIPT
fi

TEMPDIR_CHECKOUT=`mktemp -d`
>&2 echo "TEMPDIR_CHECKOUT is $TEMPDIR_CHECKOUT"

svn co "${SVNURL}/${TRUNK_PATH}" "$TEMPDIR_CHECKOUT" || exit 4;
svn import "$RELEASE_DIR/onoffice" "${SVNURL}/${TAG_PATH}/$NEW_TAG" --non-interactive -m "Create tag '$NEW_TAG'" --username "${SVN_USER}" --password "${SVN_PASSWORD}" || exit 5;
svn merge --ignore-ancestry "${SVNURL}/${TRUNK_PATH}" "${SVNURL}/${TAG_PATH}/$NEW_TAG" "$TEMPDIR_CHECKOUT" || exit 6;
cd "$TEMPDIR_CHECKOUT"
svn commit -m "Update trunk to tag '$NEW_TAG'" --non-interactive --username "${SVN_USER}" --password "${SVN_PASSWORD}" || exit 7;

exit $?